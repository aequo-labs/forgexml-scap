// Package xmlschemaoval_definitions_5_esx generated from XSD schema
// Source namespace: http://oval.mitre.org/XMLSchema/oval-definitions-5#esx
// Source XSD file: /home/mmcnew/repos/forgexml-scap/schemas/oval/5.11.2/esx-definitions-schema.xsd
// Generated by forgexml - Do not edit manually

package xmlschemaoval_definitions_5_esx

import (
	"encoding/xml"
	"regexp"
	"strings"

	xmlschemaoval_definitions_5 "github.com/aequo-labs/forgexml-scap/internal/generated/org/mitre/oval/xmlschema/oval-definitions-5"
	xmlschemaoval_results_5 "github.com/aequo-labs/forgexml-scap/internal/generated/org/mitre/oval/xmlschema/oval-results-5"
	xmlschemaoval_system_characteristics_5 "github.com/aequo-labs/forgexml-scap/internal/generated/org/mitre/oval/xmlschema/oval-system-characteristics-5"
	pkg_200009xmldsig "github.com/aequo-labs/forgexml-scap/internal/generated/org/w3/2000/09/xmldsig"
)

// GenericElement represents unknown/extension elements not defined in XSD
type GenericElement struct {
	XMLName xml.Name   `xml:""`
	Content string     `xml:",innerxml"`
	Attrs   []xml.Attr `xml:",any,attr,omitempty"`
}

// ExtractElementsWithXmlns parses raw XML and tracks which element names had xmlns declarations
// Returns map of element_name -> xmlns_uri for exact xmlns replication during marshal
// This achieves zero xmlns delta by tracking WHERE xmlns appeared in original XML
func ExtractElementsWithXmlns(xmlData []byte) map[string]string {
	elementsWithXmlns := make(map[string]string)
	xmlStr := string(xmlData)

	// Pattern to find elements with xmlns: <element_name ...xmlns="uri"...
	// Captures both prefixed and unprefixed element names
	pattern := regexp.MustCompile(`<(?:([a-zA-Z0-9_-]+):)?([a-zA-Z0-9_-]+)\s[^>]*?xmlns="([^"]+)"`)
	matches := pattern.FindAllStringSubmatch(xmlStr, -1)

	for _, match := range matches {
		if len(match) >= 4 {
			// match[1] = prefix (may be empty)
			// match[2] = element name
			// match[3] = xmlns URI
			elementName := match[2]
			xmlnsURI := match[3]
			elementsWithXmlns[elementName] = xmlnsURI
		}
	}

	return elementsWithXmlns
}

// ExtractElementPrefixes parses raw XML to build element name -> prefix mappings
func ExtractElementPrefixes(xmlData []byte) map[string]string {
	elementPrefixes := make(map[string]string)

	// Use regex to find all opening tags with prefixes: <prefix:element
	pattern := regexp.MustCompile(`<([a-zA-Z0-9_-]+):([a-zA-Z0-9_-]+)[\s>]`)
	matches := pattern.FindAllStringSubmatch(string(xmlData), -1)

	for _, match := range matches {
		if len(match) >= 3 {
			prefix := match[1]
			elementName := match[2]
			elementPrefixes[elementName] = prefix
		}
	}

	return elementPrefixes
}

// restoreElementPrefixes restores namespace prefixes on element names
// and removes redundant default xmlns from prefixed elements
func restoreElementPrefixes(xmlOutput string, elementPrefixes map[string]string) string {
	// For each element name -> prefix mapping
	for elementName, prefix := range elementPrefixes {
		// Replace opening tags: <elementName with <prefix:elementName
		// and remove default xmlns="..." since the prefix declares the namespace
		pattern := regexp.MustCompile(`<` + elementName + `(\s[^>]*)?>`)
		xmlOutput = pattern.ReplaceAllStringFunc(xmlOutput, func(match string) string {
			// Add prefix to element name
			result := "<" + prefix + ":" + elementName
			// Extract attributes (everything between element name and >)
			if len(match) > len("<"+elementName+">") {
				attrs := match[len("<"+elementName) : len(match)-1]
				// Remove default xmlns="..." attribute
				xmlnsPattern := regexp.MustCompile(` xmlns="[^"]*"`)
				attrs = xmlnsPattern.ReplaceAllString(attrs, "")
				result += attrs
			}
			result += ">"
			return result
		})

		// Replace closing tags: </elementName> with </prefix:elementName>
		xmlOutput = strings.ReplaceAll(xmlOutput, "</"+elementName+">", "</"+prefix+":"+elementName+">")
	}

	return xmlOutput
}

// replicateXmlnsPlacement removes xmlns from elements that didn't have it, keeps xmlns on elements that did
// Strategy: Parse all opening tags, remove xmlns unless element type is in elementsWithXmlns map
// This achieves zero xmlns delta by matching original xmlns placement exactly
func replicateXmlnsPlacement(xmlOutput string, elementsWithXmlns map[string]string) string {
	if len(elementsWithXmlns) == 0 {
		// No xmlns tracking - remove all nested xmlns to avoid inflation
		// Keep only root element xmlns
		firstGT := strings.Index(xmlOutput, ">")
		if firstGT == -1 {
			return xmlOutput
		}
		rootTag := xmlOutput[:firstGT+1]
		rest := xmlOutput[firstGT+1:]
		// Remove all xmlns from nested elements
		xmlnsPattern := regexp.MustCompile(` xmlns(?::[a-zA-Z0-9_-]+)?="[^"]+"`)
		rest = xmlnsPattern.ReplaceAllString(rest, "")
		return rootTag + rest
	}

	// Strategy: Find all opening tags and remove xmlns if element type not in map
	// Pattern matches: <element_name attr="val" xmlns="uri" ...>
	tagPattern := regexp.MustCompile(`<([a-zA-Z0-9_-]+)(\s[^>]*?)>`)
	result := tagPattern.ReplaceAllStringFunc(xmlOutput, func(match string) string {
		// Extract element name
		tagMatch := tagPattern.FindStringSubmatch(match)
		if len(tagMatch) < 2 {
			return match
		}
		elementName := tagMatch[1]
		attrs := ""
		if len(tagMatch) >= 3 {
			attrs = tagMatch[2]
		}

		// CRITICAL FIX: Deduplicate xmlns attributes first
		// Go's xml.MarshalIndent sometimes produces duplicate xmlns (e.g., xmlns="..." xmlns="...")
		// This happens with nested structs having XMLName with different namespaces
		// Remove all duplicate xmlns declarations, keeping only the first one
		dedupPattern := regexp.MustCompile(`(xmlns="[^"]+")`)
		matches := dedupPattern.FindAllString(attrs, -1)
		if len(matches) > 1 {
			// Found duplicates - keep only first xmlns, remove rest
			firstXmlns := matches[0]
			attrs = dedupPattern.ReplaceAllString(attrs, "")
			attrs = " " + firstXmlns + attrs
		}

		// Check if this element type should have xmlns
		expectedXmlns, shouldHaveXmlns := elementsWithXmlns[elementName]
		if shouldHaveXmlns {
			// This element should have xmlns - ensure it's present and correct
			if !strings.Contains(attrs, "xmlns=") {
				// Missing xmlns - add it
				return "<" + elementName + ` xmlns="` + expectedXmlns + `"` + attrs + ">"
			}
			// Has xmlns - verify it's correct
			if !strings.Contains(attrs, `xmlns="`+expectedXmlns+`"`) {
				// Wrong xmlns - replace it
				xmlnsPattern := regexp.MustCompile(`xmlns="[^"]+"`)
				attrs = xmlnsPattern.ReplaceAllString(attrs, `xmlns="`+expectedXmlns+`"`)
			}
			return "<" + elementName + attrs + ">"
		}

		// This element should NOT have xmlns - remove any xmlns attributes
		xmlnsPattern := regexp.MustCompile(` xmlns(?::[a-zA-Z0-9_-]+)?="[^"]+"`)
		attrs = xmlnsPattern.ReplaceAllString(attrs, "")
		return "<" + elementName + attrs + ">"
	})

	return result
}

// Patch56_stateElementType represents the XSD type 'Patch56_stateElementType'
// XSD complex type (W3C XSD §3.4)
type Patch56_stateElementType struct {
	xmlschemaoval_definitions_5.StateType // XSD extension base
	// Patch_name represents XSD element 'patch_name'
	// minOccurs=0, maxOccurs=1
	Patch_name *xmlschemaoval_definitions_5.EntityStateStringType `xml:"patch_name,omitempty"`
	// Knowledge_base_id represents XSD element 'knowledge_base_id'
	// minOccurs=0, maxOccurs=1
	Knowledge_base_id *xmlschemaoval_definitions_5.EntityStateIntType `xml:"knowledge_base_id,omitempty"`
	// Bundle_id represents XSD element 'bundle_id'
	// minOccurs=0, maxOccurs=1
	Bundle_id *xmlschemaoval_definitions_5.EntityStateIntType `xml:"bundle_id,omitempty"`
	// Classification represents XSD element 'classification'
	// minOccurs=0, maxOccurs=1
	Classification *EntityStateClassificationType `xml:"classification,omitempty"`
	// Support_level represents XSD element 'support_level'
	// minOccurs=0, maxOccurs=1
	Support_level *EntityStateSupportLevelType `xml:"support_level,omitempty"`
	// Status represents XSD element 'status'
	// minOccurs=0, maxOccurs=1
	Status *xmlschemaoval_definitions_5.EntityStateBoolType `xml:"status,omitempty"`
	// UnknownElements captures any elements not defined in XSD
	UnknownElements []GenericElement `xml:",any,omitempty"`
	// UnknownAttrs captures any attributes not defined in XSD
	UnknownAttrs []xml.Attr `xml:",any,attr,omitempty"`
}

// Patch_testElementType represents the XSD type 'Patch_testElementType'
// XSD complex type (W3C XSD §3.4)
type Patch_testElementType struct {
	xmlschemaoval_results_5.TestType // XSD extension base
	// Object represents XSD element 'object'
	Object xmlschemaoval_definitions_5.ObjectRefType `xml:"object"`
	// State represents XSD element 'state'
	// minOccurs=0, maxOccurs=-1
	State []xmlschemaoval_definitions_5.StateRefType `xml:"state,omitempty"`
	// UnknownElements captures any elements not defined in XSD
	UnknownElements []GenericElement `xml:",any,omitempty"`
	// UnknownAttrs captures any attributes not defined in XSD
	UnknownAttrs []xml.Attr `xml:",any,attr,omitempty"`
}

// PatchBehaviors represents the XSD type 'PatchBehaviors'
// XSD complex type (W3C XSD §3.4)
type PatchBehaviors struct {
	// Supersedence represents XSD attribute 'supersedence'
	// use="optional"
	Supersedence *string `xml:"supersedence,attr,omitempty"`
	// UnknownElements captures any elements not defined in XSD
	UnknownElements []GenericElement `xml:",any,omitempty"`
	// UnknownAttrs captures any attributes not defined in XSD
	UnknownAttrs []xml.Attr `xml:",any,attr,omitempty"`
}

// Visdkmanagedobject_testElementType represents the XSD type 'Visdkmanagedobject_testElementType'
// XSD complex type (W3C XSD §3.4)
type Visdkmanagedobject_testElementType struct {
	xmlschemaoval_results_5.TestType // XSD extension base
	// Object represents XSD element 'object'
	Object xmlschemaoval_definitions_5.ObjectRefType `xml:"object"`
	// State represents XSD element 'state'
	// minOccurs=0, maxOccurs=-1
	State []xmlschemaoval_definitions_5.StateRefType `xml:"state,omitempty"`
	// UnknownElements captures any elements not defined in XSD
	UnknownElements []GenericElement `xml:",any,omitempty"`
	// UnknownAttrs captures any attributes not defined in XSD
	UnknownAttrs []xml.Attr `xml:",any,attr,omitempty"`
}

// Patch56Behaviors represents the XSD type 'Patch56Behaviors'
// XSD complex type (W3C XSD §3.4)
type Patch56Behaviors struct {
	// Supersedence represents XSD attribute 'supersedence'
	// use="optional"
	Supersedence *string `xml:"supersedence,attr,omitempty"`
	// UnknownElements captures any elements not defined in XSD
	UnknownElements []GenericElement `xml:",any,omitempty"`
	// UnknownAttrs captures any attributes not defined in XSD
	UnknownAttrs []xml.Attr `xml:",any,attr,omitempty"`
}

// EntityStateSupportLevelType represents the XSD type 'EntityStateSupportLevelType'
// XSD complex type (W3C XSD §3.4)
type EntityStateSupportLevelType struct {
	xmlschemaoval_definitions_5.EntityStateStringType // XSD extension base
	// UnknownElements captures any elements not defined in XSD
	UnknownElements []GenericElement `xml:",any,omitempty"`
	// UnknownAttrs captures any attributes not defined in XSD
	UnknownAttrs []xml.Attr `xml:",any,attr,omitempty"`
}

// Version_objectElementType represents the XSD type 'Version_objectElementType'
// XSD complex type (W3C XSD §3.4)
type Version_objectElementType struct {
	pkg_200009xmldsig.ObjectType // XSD extension base
	// UnknownElements captures any elements not defined in XSD
	UnknownElements []GenericElement `xml:",any,omitempty"`
	// UnknownAttrs captures any attributes not defined in XSD
	UnknownAttrs []xml.Attr `xml:",any,attr,omitempty"`
}

// Version_stateElementType represents the XSD type 'Version_stateElementType'
// XSD complex type (W3C XSD §3.4)
type Version_stateElementType struct {
	xmlschemaoval_definitions_5.StateType // XSD extension base
	// Release represents XSD element 'release'
	// minOccurs=0, maxOccurs=1
	Release *xmlschemaoval_definitions_5.EntityStateVersionType `xml:"release,omitempty"`
	// Build represents XSD element 'build'
	// minOccurs=0, maxOccurs=1
	Build *xmlschemaoval_definitions_5.EntityStateIntType `xml:"build,omitempty"`
	// UnknownElements captures any elements not defined in XSD
	UnknownElements []GenericElement `xml:",any,omitempty"`
	// UnknownAttrs captures any attributes not defined in XSD
	UnknownAttrs []xml.Attr `xml:",any,attr,omitempty"`
}

// ViSdkManagedEntityBehaviors represents the XSD type 'ViSdkManagedEntityBehaviors'
// XSD complex type (W3C XSD §3.4)
type ViSdkManagedEntityBehaviors struct {
	// Managed_entity_type represents XSD attribute 'managed_entity_type'
	// use="optional"
	Managed_entity_type *string `xml:"managed_entity_type,attr,omitempty"`
	// UnknownElements captures any elements not defined in XSD
	UnknownElements []GenericElement `xml:",any,omitempty"`
	// UnknownAttrs captures any attributes not defined in XSD
	UnknownAttrs []xml.Attr `xml:",any,attr,omitempty"`
}

// EntityStateClassificationType represents the XSD type 'EntityStateClassificationType'
// XSD complex type (W3C XSD §3.4)
type EntityStateClassificationType struct {
	xmlschemaoval_definitions_5.EntityStateStringType // XSD extension base
	// UnknownElements captures any elements not defined in XSD
	UnknownElements []GenericElement `xml:",any,omitempty"`
	// UnknownAttrs captures any attributes not defined in XSD
	UnknownAttrs []xml.Attr `xml:",any,attr,omitempty"`
}

// Visdkmanagedobject_objectElementType represents the XSD type 'Visdkmanagedobject_objectElementType'
// XSD complex type (W3C XSD §3.4)
type Visdkmanagedobject_objectElementType struct {
	xmlschemaoval_system_characteristics_5.ObjectType // XSD extension base
	// Set represents XSD element 'set'
	Set *xmlschemaoval_definitions_5.SetElement `xml:"set,omitempty"`
	// Behaviors represents XSD element 'behaviors'
	// minOccurs=0, maxOccurs=1
	Behaviors *ViSdkManagedEntityBehaviors `xml:"behaviors,omitempty"`
	// Property represents XSD element 'property'
	Property xmlschemaoval_definitions_5.EntityObjectStringType `xml:"property"`
	// Filter represents XSD element 'filter'
	// minOccurs=0, maxOccurs=-1
	Filter []xmlschemaoval_definitions_5.FilterElement `xml:"filter,omitempty"`
	// UnknownElements captures any elements not defined in XSD
	UnknownElements []GenericElement `xml:",any,omitempty"`
	// UnknownAttrs captures any attributes not defined in XSD
	UnknownAttrs []xml.Attr `xml:",any,attr,omitempty"`
}

// Patch56_testElementType represents the XSD type 'Patch56_testElementType'
// XSD complex type (W3C XSD §3.4)
type Patch56_testElementType struct {
	xmlschemaoval_results_5.TestType // XSD extension base
	// Object represents XSD element 'object'
	Object xmlschemaoval_definitions_5.ObjectRefType `xml:"object"`
	// State represents XSD element 'state'
	// minOccurs=0, maxOccurs=-1
	State []xmlschemaoval_definitions_5.StateRefType `xml:"state,omitempty"`
	// UnknownElements captures any elements not defined in XSD
	UnknownElements []GenericElement `xml:",any,omitempty"`
	// UnknownAttrs captures any attributes not defined in XSD
	UnknownAttrs []xml.Attr `xml:",any,attr,omitempty"`
}

// Patch56_objectElementType represents the XSD type 'Patch56_objectElementType'
// XSD complex type (W3C XSD §3.4)
type Patch56_objectElementType struct {
	pkg_200009xmldsig.ObjectType // XSD extension base
	// Set represents XSD element 'set'
	Set *xmlschemaoval_definitions_5.SetElement `xml:"set,omitempty"`
	// Behaviors represents XSD element 'behaviors'
	// minOccurs=0, maxOccurs=1
	Behaviors *Patch56Behaviors `xml:"behaviors,omitempty"`
	// Patch_name represents XSD element 'patch_name'
	Patch_name xmlschemaoval_definitions_5.EntityObjectStringType `xml:"patch_name"`
	// Filter represents XSD element 'filter'
	// minOccurs=0, maxOccurs=-1
	Filter []xmlschemaoval_definitions_5.FilterElement `xml:"filter,omitempty"`
	// UnknownElements captures any elements not defined in XSD
	UnknownElements []GenericElement `xml:",any,omitempty"`
	// UnknownAttrs captures any attributes not defined in XSD
	UnknownAttrs []xml.Attr `xml:",any,attr,omitempty"`
}

// Version_testElementType represents the XSD type 'Version_testElementType'
// XSD complex type (W3C XSD §3.4)
type Version_testElementType struct {
	xmlschemaoval_definitions_5.TestType // XSD extension base
	// Object represents XSD element 'object'
	Object xmlschemaoval_definitions_5.ObjectRefType `xml:"object"`
	// State represents XSD element 'state'
	// minOccurs=0, maxOccurs=-1
	State []xmlschemaoval_definitions_5.StateRefType `xml:"state,omitempty"`
	// UnknownElements captures any elements not defined in XSD
	UnknownElements []GenericElement `xml:",any,omitempty"`
	// UnknownAttrs captures any attributes not defined in XSD
	UnknownAttrs []xml.Attr `xml:",any,attr,omitempty"`
}

// Patch_stateElementType represents the XSD type 'Patch_stateElementType'
// XSD complex type (W3C XSD §3.4)
type Patch_stateElementType struct {
	xmlschemaoval_definitions_5.StateType // XSD extension base
	// Patch_number represents XSD element 'patch_number'
	// minOccurs=0, maxOccurs=1
	Patch_number *xmlschemaoval_definitions_5.EntityStateStringType `xml:"patch_number,omitempty"`
	// Status represents XSD element 'status'
	// minOccurs=0, maxOccurs=1
	Status *xmlschemaoval_definitions_5.EntityStateBoolType `xml:"status,omitempty"`
	// UnknownElements captures any elements not defined in XSD
	UnknownElements []GenericElement `xml:",any,omitempty"`
	// UnknownAttrs captures any attributes not defined in XSD
	UnknownAttrs []xml.Attr `xml:",any,attr,omitempty"`
}

// Patch_objectElementType represents the XSD type 'Patch_objectElementType'
// XSD complex type (W3C XSD §3.4)
type Patch_objectElementType struct {
	xmlschemaoval_system_characteristics_5.ObjectType // XSD extension base
	// Set represents XSD element 'set'
	Set *xmlschemaoval_definitions_5.SetElement `xml:"set,omitempty"`
	// Behaviors represents XSD element 'behaviors'
	// minOccurs=0, maxOccurs=1
	Behaviors *PatchBehaviors `xml:"behaviors,omitempty"`
	// Patch_number represents XSD element 'patch_number'
	Patch_number xmlschemaoval_definitions_5.EntityObjectStringType `xml:"patch_number"`
	// UnknownElements captures any elements not defined in XSD
	UnknownElements []GenericElement `xml:",any,omitempty"`
	// UnknownAttrs captures any attributes not defined in XSD
	UnknownAttrs []xml.Attr `xml:",any,attr,omitempty"`
}

// Visdkmanagedobject_stateElementType represents the XSD type 'Visdkmanagedobject_stateElementType'
// XSD complex type (W3C XSD §3.4)
type Visdkmanagedobject_stateElementType struct {
	xmlschemaoval_definitions_5.StateType // XSD extension base
	// Property represents XSD element 'property'
	// minOccurs=0, maxOccurs=1
	Property *xmlschemaoval_definitions_5.EntityStateStringType `xml:"property,omitempty"`
	// Value represents XSD element 'value'
	// minOccurs=0, maxOccurs=1
	Value *xmlschemaoval_definitions_5.EntityStateAnySimpleType `xml:"value,omitempty"`
	// UnknownElements captures any elements not defined in XSD
	UnknownElements []GenericElement `xml:",any,omitempty"`
	// UnknownAttrs captures any attributes not defined in XSD
	UnknownAttrs []xml.Attr `xml:",any,attr,omitempty"`
}
